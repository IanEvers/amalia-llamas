---

import Layout from '~/layouts/PageLayout.astro';

import { useSanityClient, groq } from 'astro-sanity';
import { urlForImage } from '../image'

const lenguaje = Astro.url.searchParams.get('lang') || "es"

const obras = {
  en: 'WORKS',
  es: 'OBRAS'
}

async function getWork() {
  const query = groq `*[_type == "work"]|order(orderRank) | order(anio asc) `;
  try {
    const posts = await useSanityClient().fetch(query);
    return Array.isArray(posts) ? posts : [];
  } catch (err) {
    console.error('Failed to fetch works from Sanity', err);
    return [];
  }
}

const work = await getWork();

const años = getDistinctAnioValues(work)

function getDistinctAnioValues(data) {
  const anioSet = new Set();
  
  data.forEach(item => {
    anioSet.add(item.anio);
  });
  
  return Array.from(anioSet);
}

function getImageSrc(imagen) {
  if (!imagen) return null;

  const assetId = imagen?.asset?._ref || imagen?.asset?._id;
  if (assetId) {
    return urlForImage(imagen).url();
  }

  // Fallback to Sanity upload preview image while asset is unavailable
  if (imagen?._upload?.previewImage) {
    return imagen._upload.previewImage;
  }

  return null;
}

---


<Layout >
  <div class="mx-8 m-auto">
    <h1 class="text-3xl m-2 lg:my-6 lg:text-4xl ">{obras[lenguaje]}</h1>
    <hr class=" border-gray-700 mb-3 opacity-40">
    <div class="lg:flex gap-24 mx-2 ">
      <div class="lg:mt-20">
        <div class="sticky top-24">
          {
            años.reverse().map((año) => {
              return (
                <button class="block hover:underline botonAño" value={`${año}`}> {año} </button>
              )
            })
          }
        </div>
      </div>
      <div class="w-full flex-1">
        {work.length === 0 ? <p class="opacity-70">No hay obras para mostrar.</p> : null}
        {
          work.map((obra) => {
            const imagenSrc = getImageSrc(obra?.imagen);
            const altText = (obra?.nombre && typeof obra.nombre === 'object')
              ? obra.nombre[lenguaje] || ''
              : '';
            return (
              <div class={'obra my-20'} data-año={obra.anio} >
                <div class="lg:flex justify-between w-full">
                  {imagenSrc ? (
                    <img
                      src={imagenSrc}
                      loading="lazy"
                      alt={altText}
                      class=" w-auto  max-h-[400px] lg:max-w-[75%] pr-2"
                    />
                  ) : null}
                  <div class="lg:mr-4">
                    
                    <h3 class="text-lg font-bold lg:text-right">{obra.nombre ? obra.nombre[lenguaje] : ''}</h3>
                    <p class="">{obra.descripcion ? obra.descripcion[lenguaje] : ''}</p>
                  </div>
                </div>
                  
              </div>
            )
          })
        }
      </div>
    </div>
  </div>

</Layout>

<script>


let buttons = document.querySelectorAll<HTMLButtonElement>('.botonAño');

function initYearSelection() {
  buttons = document.querySelectorAll<HTMLButtonElement>('.botonAño');
  buttons.forEach((button) => {
    button.addEventListener('click', () => cambiarAñoSeleccionado(button.value));
  });

  if (buttons.length > 0) {
    console.log(buttons);
    // Select the first year by default on page load
    if (buttons[0].value && buttons[0].value !== 'undefined') {
      console.log(buttons[0].value);
      cambiarAñoSeleccionado(buttons[0].value);
    } else {
      console.log(buttons[1].value);
      cambiarAñoSeleccionado(buttons[1].value);
    }
  }
}

function cambiarAñoSeleccionado(año) {
  const obras = document.querySelectorAll<HTMLElement>('.obra')

  buttons.forEach((boton) => {
    if(boton.value == año) {
      boton.classList.add('font-bold')
      boton.classList.add('underline')
    } else {
      boton.classList.remove('font-bold')
      boton.classList.remove('underline')

    }
  })

  obras.forEach(( obra) => {

    if(obra.dataset.año == año ) {
      obra.classList.add('block')
      obra.classList.remove('hidden')
    } else {
      obra.classList.remove('block')
      obra.classList.add('hidden')
    }
  })
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initYearSelection);
} else {
  buttons = document.querySelectorAll<HTMLButtonElement>('.botonAño');
  initYearSelection();
}
  
</script>


